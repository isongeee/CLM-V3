name: Promote Branch

on:
  workflow_dispatch:
    inputs:
      lane:
        description: "Promotion lane"
        required: true
        type: choice
        options:
          - development_to_staging
          - staging_to_main

permissions:
  contents: read
  pull-requests: write

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve lane
        id: lane
        shell: bash
        run: |
          case "${{ inputs.lane }}" in
            development_to_staging)
              echo "from=development" >> "$GITHUB_OUTPUT"
              echo "to=staging" >> "$GITHUB_OUTPUT"
              ;;
            staging_to_main)
              echo "from=staging" >> "$GITHUB_OUTPUT"
              echo "to=main" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Unknown lane" >&2
              exit 1
              ;;
          esac

      - name: Create or reuse PR
        uses: actions/github-script@v7
        with:
          script: |
            const from = "${{ steps.lane.outputs.from }}";
            const to = "${{ steps.lane.outputs.to }}";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: `${owner}:${from}`,
              base: to,
              per_page: 50,
            });

            if (prs.length > 0) {
              core.notice(`PR already open: ${prs[0].html_url}`);
              return;
            }

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head: from,
              base: to,
              title: `Promote ${from} â†’ ${to}`,
              body: `Automated promotion PR from \`${from}\` into \`${to}\`.\n\n- Merge this PR after CI is green.\n- Prefer squash merge into staging/main.\n`,
            });

            core.notice(`Created PR: ${pr.html_url}`);

